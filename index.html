<html>
<head>
<meta charset="utf-8">
<title>Rossum Embedded Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
<link rel="stylesheet" type="text/css" href="main.css">
<script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<body>
<script type="text/javascript">
/*** General tools */

function showError(msg) {
	/* TODO */
	window.alert(msg);
}


/*** Rossum API */

function rossum_api(method, endpoint, params, type=null) {
	var payload = new FormData();
	Object.entries(params).forEach(e => { payload.append(e[0], e[1]) });
	console.log(method, endpoint, params, Object.entries(params), payload.entries());
	var url = localStorage.apiUrl + endpoint;
	return $.ajax({
		type: method,
		url: url,
		data: payload,
		processData: false,
		xhrFields: {
			withCredentials: true
		    },
		contentType: false,
		beforeSend: function (xhr) {
			if (localStorage.admin_token && (!type || type === 'admin')) {
				xhr.setRequestHeader('Authorization', 'token ' + localStorage.admin_token);
			}
			else if (localStorage.embed_token && (!type || type === 'embed')) {
				xhr.setRequestHeader('Authorization', 'token ' + localStorage.embed_token);
			}
		    },
		error: function(res) {
			showError('Rossum API error ' + res.code + ': ' + res.responseText);
		}
	});
}

function submitFile(queue_id, file) {
	return rossum_api('POST', 'v1/queues/' + queue_id + '/upload/' + file.name, {content: file}, 'admin');
}


/*** Embedded methods */

function selfDocumentUrl(doc_id) {
	var qi = window.location.href.indexOf('?');
	var return_url = qi != -1 ? window.location.href.substring(0, qi) : window.location.href;
	return_url += '?doc_id=' + doc_id;
	return return_url;
}

function selfBaseUrl() {
	var qi = window.location.href.lastIndexOf('/');
	return window.location.href.substring(0, qi + 1);
}

function embeddedRedirect(doc_id) {
	var return_url = selfDocumentUrl(doc_id);

	/* At this point, the browser window is redirected to the Rossum app.
	 * (First, the Rossum app validation URL for this document is requested
	 * from the API, then the redirect is executed.) */
	rossum_api('POST', 'v1/annotations/' + doc_id + '/create_embedded_url', {
		'locale': 'cs_CZ',
		'return_url': return_url,
		'cancel_url': window.location.href
	}, 'embed')
		.then(res => { window.location.href = res.url; });

	/* After clicking the [Confirm] button in the Rossum app, the document
	 * status changes and the browser window is redirected to the `return_url`
	 * which is our app again, just set up to show the captured data for this
	 * document. */
}

function embeddedIFrame(doc_id) {
	/* At this point, the IFrame window is redirected to the Rossum app. */
	rossum_api('POST', 'v1/annotations/' + doc_id + '/create_embedded_url',
			{
				'locale': 'cs_CZ',
				'return_url': selfBaseUrl() + 'return.html?doc_id=' + doc_id,
				'cancel_url': selfBaseUrl() + 'cancel.html',
			}, 'embed')
		.then(res => { $('#iframe').attr('src', res.url); });


	$('#iframe_box').show();

	/*$([document.documentElement, document.body]).animate({
			scrollTop: $("#iframe_box").offset().top
		}, 2000);*/

	/* Now, wait for a message coming back from the iframe and act accordingly. */

	function receiveMessage() {
		/* XXX: Verify origin. */
		console.log('>>> received iframe message:', event);
		if (event.data && parseInt(event.data) == event.data) {
			/* Confirm. */
			window.location.href = selfDocumentUrl(parseInt(event.data));
		} else {
			/* Cancel. */
			$('#iframe_box').hide();
		}
		window.removeEventListener("message", receiveMessage, false);
	}
	window.addEventListener("message", receiveMessage, false);
}

function embeddedPopup(doc_id) {
	rossum_api('POST', 'v1/annotations/' + doc_id + '/create_embedded_url',
			{
				'locale': 'cs_CZ',
				'return_url': selfBaseUrl() + 'return.html?doc_id=' + doc_id,
				'cancel_url': selfBaseUrl() + 'cancel.html',
			}, 'embed')
		.then(res => { window.open(res.url, 'embeddedwindow'); });

	/* Now, wait for a message coming back from the popup and act accordingly. */

	function receiveMessage() {
		/* XXX: Verify origin. */
		console.log('>>> received popup message:', event);
		if (event.data && parseInt(event.data) == event.data) {
			/* Confirm. */
			window.location.href = selfDocumentUrl(parseInt(event.data));
		} else {
			/* Cancel. */
		}
		window.removeEventListener("message", receiveMessage, false);
	}
	window.addEventListener("message", receiveMessage, false);
}


/*** Display methods */

function docToObject(docobj, docres) {
	console.log('docres', docres);
	docres.forEach(dp => {
		if (dp.category == 'datapoint') {
			docobj[dp.schema_id] = dp.content.value;
		} else if (dp.category == 'section') {
			docobj = docToObject(docobj, dp.children);
		}
	});
	return docobj;
}

function renderDoc(docobj) {
	$('#qr_table').empty();

	Object.entries(docobj).forEach(e => {
		$('#qr_table').append('<tr><td>' + e[0] + '</td><td>' + e[1] + '</td></tr>');
	});
}

function showDoc(doc_id) {
	return rossum_api('GET', 'v1/annotations/' + doc_id + '/content', {}).then(res => renderDoc(docToObject({}, res.content)));
}


/*** Listing methods */

function loadList(queue_id, doc_status) {
    if (!Array.isArray(doc_status) || doc_status.length === 0) {
        return Promise.resolve([]);
    }

    const fetchPromises = doc_status.map(status => {
        const url = 'v1/annotations?queue=' + queue_id + '&status=' + status + '&sideload=documents';
        return rossum_api('GET', url, {});
    });

    return Promise.all(fetchPromises)
        .then(results => {
            let allDocs = [];
            results.forEach(res => {
                if (res && Array.isArray(res.results)) {
                    allDocs = allDocs.concat(res.results);
                }
            });
            console.log('Combined results for statuses:', doc_status, allDocs);
            return allDocs;
        })
        .catch(error => {
            console.error('Error fetching documents for multiple statuses:', error);
            throw error;
        });
}

function renderList(list_name, docs) {
	list_id = '#' + list_name + '_list'
	console.log('RENDER *** ', list_id, docs);
	$(list_id).empty();
	$(list_id).append('<tr><th>Rossum Document ID</th></tr>');

	if (docs.length == 0) {
		$(list_id).append('<tr><td class="tableDocId">' + 'No documents to show.' + '</td>' + '</tr>');
	}

	for (var i = 0; i < docs.length; i++) {
		var doc = docs[i];
		console.log('___', doc);
		var td_button = '';
		if (list_id == '#validate_list') {
				td_button = '<td class="tableAnnotate">'
					+ '<button class="embed-button" id="redir_' + doc.id + '">Redirect</button>'
					+ '<button class="embed-button" id="popup_' + doc.id + '">Popup</button>'
					+ '<button class="embed-button" id="iframe_' + doc.id + '">IFrame</button>'
					+ '</td>';

		} else if (list_id == '#done_list') {
			td_button = '<td class="tableAnnotate"><a href="?doc_id=' + doc.id + '">Display</a></td>';
		}
		$(list_id).append('<tr><td class="tableDocId">' + doc.id + '</td>' + td_button + '</tr>');
		$(document).on('click', '#redir_' + doc.id, e => { embeddedRedirect(doc.id) });
		$(document).on('click', '#popup_' + doc.id, e => { embeddedPopup(doc.id) });
		$(document).on('click', '#iframe_' + doc.id, e => { embeddedIFrame(doc.id) });
		$('.embed-button').prop('disabled', !localStorage.embed_token);
	}
	if (docs.length > 0) {
		$('#' + list_name + '_box').show();
	}
}

function setList(list_id, queue_id, doc_status) {
	var p = loadList(queue_id, doc_status);
	console.log(list_id, doc_status, p);
	p.then(docs => renderList(list_id, docs));
}

function updateProcessing(queue_id) {
	return setList('processing', queue_id, ['importing']);
}

function updateLists(queue_id) {
	$('#processing_list').ready(function() { updateProcessing(queue_id); });
	$('#validate_list').ready(function() { setList('validate', queue_id, ['to_review', 'reviewing']); });
	$('#done_list').ready(function() { setList('done', queue_id, ['exporting', 'exported', 'confirmed']); });

	setTimeout(function() { updateLists(queue_id) }, 10000);
	$('#upload_banner').hide();
}


/*** Initialize app */


$(document).ready(function() { $('#credentials_submit').click(tryLogin); });

$(document).ready(function() {
	$('#admin_username').val(localStorage.admin_username);
	$('#admin_password').val(localStorage.admin_password);
	$('#embed_username').val(localStorage.embed_username);
	$('#embed_password').val(localStorage.embed_password);
	$('#queue_url').val(localStorage.queue_url);
	delete localStorage.admin_token;
	delete localStorage.embed_token;
	tryLogin();
});

// fix the scrolling
$(document).ready(function() {
    $('#iframe').hover(
        function() {
            // Mouse entered the iframe
            $('body').css('overflow', 'hidden');
        },
        function() {
            // Mouse left the iframe
            $('body').css('overflow', ''); // Or 'auto'
        }
    );
});

$('#load_box').show();
$(document).on('change', '#file_input', e => {
	for (var i = 0; i < e.target.files.length; i++) {
		submitFile(localStorage.queue_id, e.target.files[i]).then(function () {
			updateProcessing(localStorage.queue_id)
		});
	}
	$('#upload_banner').show();
});

function extractIdFromUrl(url) {
  try {
    const urlObj = new URL(url);
    const params = new URLSearchParams(urlObj.search);

    const filtering = params.get('filtering');
    if (filtering) {
      const decodedFiltering = decodeURIComponent(filtering);
      const filteringObj = JSON.parse(decodedFiltering);

      if (filteringObj && filteringObj.items && Array.isArray(filteringObj.items)) {
        for (const item of filteringObj.items) {
          if (item.field === 'queue' && item.operator === 'isAnyOf' && Array.isArray(item.value) && item.value.length > 0) {
            return item.value[0];
          }
        }
      }
    }
    return null;
  } catch (error) {
    console.error("Error parsing URL or filtering parameter:", error);
    return null;
  }
}

function tryLogin() {
	/* Some global variables. */
	localStorage.admin_username = $('#admin_username').val();
	localStorage.admin_password = $('#admin_password').val();
	localStorage.embed_username = $('#embed_username').val();
	localStorage.embed_password = $('#embed_password').val();
	localStorage.queue_url = $('#queue_url').val();
	localStorage.apiUrl = new URL(localStorage.queue_url).origin + "/api/"

	queue_id = extractIdFromUrl(localStorage.queue_url)

	if (!queue_id || parseInt(queue_id) != queue_id) {
		window.alert('Error parsing the queue URL.');
		return;
	}
	localStorage.queue_id = queue_id;

	/* Obtain token. */
	if (localStorage.admin_token && (!localStorage.admin_username || !localStorage.admin_password))
		delete localStorage.admin_token;
		$('#file_input').prop('disabled', !localStorage.admin_token);
	if (!localStorage.admin_token && localStorage.admin_username && localStorage.admin_password)
	{
		rossum_api('POST', 'v1/auth/login', {'username': localStorage.admin_username, 'password': localStorage.admin_password}, 'admin')
			.done(res => {
				console.log(res);
				localStorage.admin_token = res.key;
				initApp();
				$('#file_input').prop('disabled', !localStorage.admin_token);
			});
	}

	if (localStorage.embed_token && (!localStorage.embed_username || !localStorage.embed_password))
		delete localStorage.embed_token;
		$('.embed-button').prop('disabled', !localStorage.embed_token);
	if (!localStorage.embed_token && localStorage.embed_username && localStorage.embed_password)
		{
		rossum_api('POST', 'v1/auth/login', {'username': localStorage.embed_username, 'password': localStorage.embed_password}, 'embed')
			.done(res => {
				console.log(res);
				localStorage.embed_token = res.key;
				initApp();
				$('.embed-button').prop('disabled', !localStorage.embed_token);
			});
	}
}

function initApp() {
	updateLists(localStorage.queue_id);
	var urlParams = new URLSearchParams(window.location.search);
	if (urlParams.has('doc_id')) {
		$('#qr_display').show();
		showDoc(urlParams.get('doc_id'));
	}
}

</script>

</head>

<div class="top-menu"><h1>Some Company App</h1></div>
<div class="project-navigation"><h2>Projects / Invoices</h2></div>

<div class="explanation">
	<p>Rossum validation interface can be embedded into a third-party app. That allows users to enjoy the Rossum validation interface (with its speedy validation and AI feedback) while keeping the app they use. No extra login is required, a document is directly shown to the user and on confirming it, the user is immediately returned to the app.</p>
	<p>This page showcases this capability. It demoes three ways to embed Rossum in an external app: redirect-based (the standard way), popup-based and iframe-based. After validation is completed, the captured data is shown on the page.</p>
	<p>Check out the source at the <a href="https://github.com/rossumai/embedded-demo">GitHub rossumai/embedded-demo</a>. More detailed intro to the embedded mode is on <a href="https://developers.rossum.ai/docs/rossum-embedded-in-other-apps">Rossum's Developer Hub</a>.
</div>

<div class="api-authentication">
	<h3>API Authentication</h3>
	<p>The API communication requires Rossum login information. Usually, the backend of the external app would perform the login based on fixed secret credentials, and share only a short-lived token with the frontend for authenticated users. </p>
	<p>If you do not have an account yet, <a href="https://rossum.app/registration">register for a free trial</a>.</p>
	<p>After finishing the registration and creating access with the main admin account, you need to create another access for the embedding access. Continue to Settings->Users->Add user and create an user with Annotator Embedded role.</p>

<form id="credentials">
    <div>
        <p><b>Admin/main username:</b> <input type="text" id="admin_username" placeholder="email@example.com"></p>
        <p><b>Admin/main password:</b> <input type="password" id="admin_password"></p>
       <p>*must be filled if you want to upload a document</p>
    </div>
    <div>
        <p><b>Embedded username:</b> <input type="text" id="embed_username" placeholder="email@example.com"></p>
        <p><b>Embedded password:</b> <input type="password" id="embed_password"></p>
       <p>*must be filled if you want to try embedding</p>
    </div>
    <p><b>Queue URL*:</b> <input type="text" id="queue_url" size="50" placeholder="https://company.rossum.app/documents?filtering=..."></p>
    <p>*browser url address after logging into Rossum, or after picking some category/queue in the menu</p>
    <p style="flex-basis: 100%;"><input type="button" id="credentials_submit" value="Login"></p>
</form>

</div>

<div class="dashboard">

	<section id="load_box">
	<form id="upload_form" enctype="multipart/form-data">
		<b>Upload new Invoice:</b>
		<input disabled name="file" type="file" id="file_input" multiple>
	</form>
		<div id="upload_banner" style="display: none;"><p style="background-color: LightGreen;"><b>Uploaded documents are being processed below...</b></p></div>
	</section>

	<div id="qr_display" style="display: none">
		<section>
			<h2>Document</h2>
			<div class="container">
			  <div class="row">
				<div class="col-sm-4">
				<div id="qr_code"></div>
				</div>
				<div class="col-sm-8">
				<table id="qr_table" class="table">
				</table>
				</div>
			  </div>
			</div>
		</section>
	</div>

	<section id="iframe_box" style="display: none">
	<h2>IFrame Area</h2>
	<iframe id="iframe"></iframe>
	</section>

	<section id="processing_box">
		<h2>Documents being processed</h2>
		<p>These documents are currently being processed by the AI – the list is refreshed every two seconds.</p>
		<table id="processing_list">
		</table>
	</section>

	<section id="validate_box">
		<h2>Ready for validation</h2>
		<p>To use embedded validation from this website, you must log in with your embedded account.</p>
		<table id="validate_list" class="table">
		</table>
	</section>

	<section id="done_box">
		<h2>Past validated documents</h2>
		<table id="done_list">
		</table>
	</section>
</div>

</body>
</html>
